<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>starsmashertools.lib.output &mdash; starsmashertools</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=61ccec80"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            starsmashertools
          </a>
              <div class="version">
                14.12.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cliprograms.html">CLI Programs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../starsmashertools.helpers.html">helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../starsmashertools.lib.html">lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../starsmashertools.math.html">math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../starsmashertools.mpl.html">mpl</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">starsmashertools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">starsmashertools.lib.output</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for starsmashertools.lib.output</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">starsmashertools.preferences</span>
<span class="kn">from</span> <span class="nn">starsmashertools.preferences</span> <span class="kn">import</span> <span class="n">Pref</span>
<span class="kn">import</span> <span class="nn">starsmashertools.helpers.argumentenforcer</span>
<span class="kn">from</span> <span class="nn">starsmashertools.helpers.apidecorator</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.axes</span>
    <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_matplotlib</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Output">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output">[docs]</a>
<span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">use</span>
<span class="k">class</span> <span class="nc">Output</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container for StarSmasher binary output data, usually appearing as</span>
<span class="sd">    ``out*.sph`` in simulation directories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;raw&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cgs&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<div class="viewcode-block" id="Output.__init__">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.__init__">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">simulation</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The file path to a ``StarSmasher`` binary output data file.</span>
<span class="sd">        </span>
<span class="sd">        simulation : :class:`~.simulation.Simulation`</span>
<span class="sd">            The :class:`~.simulation.Simulation` object that this output file </span>
<span class="sd">            belongs to.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        mode : str, default = &#39;raw&#39;</span>
<span class="sd">            Affects the units of the data. Deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.string</span>
        
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Output</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">list_to_string</span><span class="p">(</span><span class="n">Output</span><span class="o">.</span><span class="n">modes</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Keyword argument &#39;mode&#39; must be one of </span><span class="si">%s</span><span class="s2">, not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;header&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_path_and_simulation</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="kn">import</span> <span class="nn">starsmashertools</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">get_simulation</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">])</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">simulation</span>

    <span class="k">def</span> <span class="nf">_get_relpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1"># Used when pickling</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span>
            <span class="s1">&#39;simulation&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
            <span class="s1">&#39;mode&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="s1">&#39;mask&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
        <span class="p">}</span>
    
    <span class="c1"># Used when pickling</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
            <span class="n">starsmashertools</span><span class="o">.</span><span class="n">get_simulation</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;simulation&#39;</span><span class="p">]),</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Output.__getitem__">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.__getitem__">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the file has not yet been read, read it. Then return the requested</span>
<span class="sd">        item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">ensure_read</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_read</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;cgs&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Output</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Use this to make sure that the file has been fully read</span>
    <span class="k">def</span> <span class="nf">_ensure_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="n">header</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                <span class="n">data</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">))</span>
        <span class="c1"># If no cache is defined in preferences</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_masked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        
<div class="viewcode-block" id="Output.keys">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.keys">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ensure_read</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ensure_read</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="p">)</span></div>

    
<div class="viewcode-block" id="Output.values">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.values">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ensure_read</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ensure_read</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_read</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Output.items">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.items">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ensure_read</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ensure_read</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_read</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Output.copy_from">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.copy_from">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">copy_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span> <span class="p">:</span> <span class="s1">&#39;starsmashertools.lib.output.Output&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">ensure_read</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="k">del</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_original_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_mask</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">ensure_read</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">_isRead</span><span class="p">)</span></div>

    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]:</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove keys associated with the current header</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># Remove keys associated with the current data</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">ensure_read</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">return_headers</span> <span class="o">=</span> <span class="n">header</span><span class="p">,</span>
                <span class="n">return_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">return_headers</span> <span class="o">=</span> <span class="n">header</span><span class="p">,</span>
                <span class="n">return_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">header</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">return_headers</span> <span class="o">=</span> <span class="n">header</span><span class="p">,</span>
                <span class="n">return_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isRead</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
<div class="viewcode-block" id="Output.from_cache">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.from_cache">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">from_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="Output.mask">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.mask">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot apply more than 1 mask to an Output object&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ntot&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The given mask does not contain particle IDs but its length (</span><span class="si">%d</span><span class="s2">) != the number of particles (</span><span class="si">%d</span><span class="s2">) in the output file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ntot&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="Output.unmask">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.unmask">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">unmask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># We should really store the cached values that we obtained while being</span>
        <span class="c1"># masked so that we don&#39;t have to recalculate them, but doing so would</span>
        <span class="c1"># be difficult. So we just make it simple and clear the cache.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_data</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Output.get_core_particles">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.get_core_particles">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">get_core_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the IDs of any core particles present in this output file. A core</span>
<span class="sd">        particle is identified in ``StarSmasher`` as having the unique property</span>
<span class="sd">        of zero specific internal energy. This is because core particles act </span>
<span class="sd">        only gravitationally on other particles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">            Integer IDs of the core particles in this output file, if there are</span>
<span class="sd">            any. Note that the IDs are zero&#39;th indexed, unlike the particle IDs</span>
<span class="sd">            in ``StarSmasher``, which start at index 1 instead of 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">][</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Output.get_non_core_particles">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.get_non_core_particles">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">get_non_core_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to :meth:`~.get_core_particles`\, but instead returns the IDs of</span>
<span class="sd">        the particles which are not identified as being core particles.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray`</span>
<span class="sd">            Non-core-particle IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">][</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Output.condense">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.condense">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">condense</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">identifier</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">func</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">args</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(),</span>
            <span class="n">kwargs</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="n">mask</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">overwrite</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">max_stored</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Pref</span><span class="p">(</span><span class="s1">&#39;condense.max stored&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an operation as defined by a string or function using this</span>
<span class="sd">        :class:`~.Output` object. The result is saved to the </span>
<span class="sd">        :class:`~.simulation.Simulation` archive for quick access in the</span>
<span class="sd">        future.</span>
<span class="sd">        </span>
<span class="sd">        Values stored in the simulation archive will be erased when &quot;max stored</span>
<span class="sd">        condense results&quot; in :mod:`starsmashertools.preferences` is reached,</span>
<span class="sd">        per output file. If this value is changed, the stored results will be </span>
<span class="sd">        updated automatically the next time this function is called, but only </span>
<span class="sd">        for this output object. The identifiers which were accessed most </span>
<span class="sd">        recently are kept.</span>
<span class="sd">        </span>
<span class="sd">        It is good practice to ensure the value returned by your ``func`` </span>
<span class="sd">        argument is small, so that many of them can be stored in the simulation</span>
<span class="sd">        archive. You could also use this method just to store a large object </span>
<span class="sd">        from a single output file, but it is generally not recommended because</span>
<span class="sd">        it significantly increases the overhead of retrieving values from the </span>
<span class="sd">        simulation archive.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        identifier : str</span>
<span class="sd">           The name to use when storing the result of ``func`` in the simulation</span>
<span class="sd">           archive. If ``overwrite = False`` then the value which is stored in </span>
<span class="sd">           the simulation archive with key ``identifier`` will be returned and </span>
<span class="sd">           no calculations will be done.</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        func : str, :class:`typing._CallableType`\, None, default = None</span>
<span class="sd">           If `None`\, no calculations will be done and the simulation archive</span>
<span class="sd">           will be searched for ``identifier``\. If no key is found matching</span>
<span class="sd">           ``identifier`` for this output file, a :py:class:`KeyError` will be</span>
<span class="sd">           raised. Keyword ``overwrite`` is ignored in this case.</span>
<span class="sd">           </span>
<span class="sd">           If type :py:class:`str` is given, it will be given as input to an </span>
<span class="sd">           :py:func:`exec` call. In this case, variables will be accessible as</span>
<span class="sd">           the names of the keys in this :class:`~.Output` object, such as </span>
<span class="sd">           ``&#39;x&#39;\, ``&#39;rho&#39;``\, etc., including keys which are in </span>
<span class="sd">           :mod:`starsmashertools.preferences`\. The string must set a</span>
<span class="sd">           variable called ``&#39;result&#39;``\, the contents of which will be saved in</span>
<span class="sd">           the simulation archive.</span>
<span class="sd">        </span>
<span class="sd">           If type :class:`typing._CallableType` is given, it must be a function</span>
<span class="sd">           which accepts a single input that is this :class:`~.Output` object </span>
<span class="sd">           and it must return an object that can be serialized, such as those</span>
<span class="sd">           in :attr:`~.helpers.jsonfile.serialization_methods`\. This is so</span>
<span class="sd">           that it can be saved in the simulation&#39;s archive.</span>
<span class="sd">        </span>
<span class="sd">        args : list, tuple, default = ()</span>
<span class="sd">           Positional arguments passed directly to ``func`` when it is of type</span>
<span class="sd">           :class:`typing._CallableType`\.</span>

<span class="sd">        kwargs : dict, default = {}</span>
<span class="sd">           Keyword arguments passed directly to ``func`` when it is of type</span>
<span class="sd">           :class:`typing._CallableType`\.</span>
<span class="sd">        </span>
<span class="sd">        mask : :class:`numpy.ndarray`\, list, tuple, None, default = None</span>
<span class="sd">           If not `None`\, the mask will be applied to this :class:`~.Output`</span>
<span class="sd">           object using :meth:`~.mask`\.</span>

<span class="sd">        overwrite : bool, default = False</span>
<span class="sd">           Ignored if ``func`` is `None`\.</span>

<span class="sd">           If `False` and the simulation archive already contains the given</span>
<span class="sd">           ``identifier`` then the archived value is returned. Otherwise, the</span>
<span class="sd">           result of ``func`` is added to the simulation archive.</span>
<span class="sd">           </span>
<span class="sd">           If `True`\, then the result of ``func`` is added to the simulation </span>
<span class="sd">           archive if it doesn&#39;t already exists, and replaces the value in the </span>
<span class="sd">           archive if it does.</span>

<span class="sd">        max_stored : int, default = ``Pref(&#39;condense.max stored&#39;, 10000)``</span>
<span class="sd">           The maximum number of results from Output.condense that is allowed to</span>
<span class="sd">           be stored in the simulation archives per output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The value returned depends on the contents of positional argument </span>
<span class="sd">        ``func``\, and/or the contents of the simulation archive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">archive_key</span> <span class="o">=</span> <span class="s1">&#39;Output.condense&#39;</span>
        <span class="n">archive_value</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">archive_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archive_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">archive</span><span class="p">[</span><span class="n">archive_key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relpath</span><span class="p">()</span>
        <span class="c1"># Make sure this output file exists in the archived values</span>
        <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">archive_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">max_stored</span><span class="p">:</span>
            <span class="c1"># Reduce the number of stored values</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">+=</span> <span class="p">[</span><span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">][</span><span class="n">key</span><span class="p">]]</span>
            
            <span class="c1"># Sort keys by oldest-to-newest access times</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">keys</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;access time&#39;</span><span class="p">])]</span>

            <span class="n">ndel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">max_stored</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">ndel</span><span class="p">:]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">ndel</span><span class="p">:]</span>

            <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)}</span>
        
        
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Find the pre-existing identifier or throw an error if it doesn&#39;t</span>
            <span class="c1"># exist</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Identifier &#39;</span><span class="si">%s</span><span class="s2">&#39; not found in the simulation archive for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Run calculations</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">loc</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;result&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;func&#39; is of type &#39;str&#39; but it does not set variable &#39;result&#39;&quot;</span><span class="p">)</span>
                    <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">][</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># It&#39;s a function</span>
                    <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">][</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span> <span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                    <span class="p">}</span>

                <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmask</span><span class="p">()</span>
            <span class="c1"># Otherwise, we don&#39;t need to run any calculations. Just access the</span>
            <span class="c1"># value in the simulation archive.</span>
        
        <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">][</span><span class="n">identifier</span><span class="p">][</span><span class="s1">&#39;access time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Save to the archive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">archive_key</span><span class="p">,</span>
            <span class="n">archive_value</span><span class="p">,</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">archive_value</span><span class="p">[</span><span class="n">relpath</span><span class="p">][</span><span class="n">identifier</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Output.rotate">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.rotate">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">keys</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vxdot&#39;</span><span class="p">,</span> <span class="s1">&#39;vydot&#39;</span><span class="p">,</span> <span class="s1">&#39;vzdot&#39;</span><span class="p">)],</span>
            <span class="n">xangle</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">yangle</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="n">zangle</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate the particles using an Euler rotation.</span>

<span class="sd">        An Euler rotation can be understood as follows. Imagine the x, y, and z</span>
<span class="sd">        axes as dowels. First the z-axis dowel is rotated `zangle` degrees</span>
<span class="sd">        clockwise, then the y-axis dowel is rotated `yangle` degrees clockwise,</span>
<span class="sd">        and finally the x-axis dowel is rotated `xangle` degrees clockwise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keys : list, tuple, :class:`numpy.ndarray`\, default = ``[(&#39;x&#39;, &#39;y&#39;, &#39;z&#39;), (&#39;vx&#39;, &#39;vy&#39;, &#39;vz&#39;), (&#39;vxdot&#39;, &#39;vydot&#39;, &#39;vzdot&#39;)]``</span>
<span class="sd">            The particle quantities to rotate. You should carefully specify all</span>
<span class="sd">            vector particle quantities (those with x, y, and z components).</span>

<span class="sd">        xangle : float, default = 0.</span>
<span class="sd">            The x component of an Euler rotation in degrees. Either `xangle` or</span>
<span class="sd">            `yangle` can be thought of as equivalent to polar angle &quot;theta&quot;, but</span>
<span class="sd">            not both.</span>
<span class="sd">        </span>
<span class="sd">        yangle : float, default = 0.</span>
<span class="sd">            The y component of an Euler rotation in degrees. Either `xangle` or</span>
<span class="sd">            `yangle` can be thought of as equivalent to polar angle </span>
<span class="sd">            :math:`\\theta`\.</span>

<span class="sd">        zangle : float, default = 0.</span>
<span class="sd">            The z component of an Euler rotation in degrees. This can be thought</span>
<span class="sd">            of as equivalent to azimuthal angle :math:`\\phi`\.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.math</span>
        
        <span class="k">for</span> <span class="n">xkey</span><span class="p">,</span> <span class="n">ykey</span><span class="p">,</span> <span class="n">zkey</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">xkey</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">ykey</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">zkey</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">xkey</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">ykey</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="n">zkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>
                <span class="n">xangle</span> <span class="o">=</span> <span class="n">xangle</span><span class="p">,</span>
                <span class="n">yangle</span> <span class="o">=</span> <span class="n">yangle</span><span class="p">,</span>
                <span class="n">zangle</span> <span class="o">=</span> <span class="n">zangle</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Output.get_extents">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.get_extents">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">get_extents</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">radial</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">r</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the x, y, and z bounds of the simulation, where the minima are found</span>
<span class="sd">        as ``min(x - 2*h)`` and maxima ``max(x + 2*h)`` for the x-axis and </span>
<span class="sd">        similarly for the y and z axes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radial : bool, default = False</span>
<span class="sd">            If True, returns a</span>
<span class="sd">            :class:`~.helpers.extents.RadialExtents` instead of a</span>
<span class="sd">            :class:`~.helpers.extents.Extents`\. Use this if you</span>
<span class="sd">            want the extents of a spherically symmetric simulation, such as a</span>
<span class="sd">            :class:`~.relaxation.Relaxation`\.</span>

<span class="sd">        r : list, tuple, :class:`numpy.ndarray`\, None, default = None</span>
<span class="sd">            The radii of the particle kernels. If `None` then the kernels are</span>
<span class="sd">            assumed to have radii 2h.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`~.helpers.extents.Extents` or :class:`~.helpers.extents.RadialExtents`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.extents</span>

        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">units</span>
        
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">radial</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">extents</span><span class="o">.</span><span class="n">RadialExtents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">extents</span><span class="o">.</span><span class="n">Extents</span><span class="p">(</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">label</span><span class="p">),</span>
        <span class="p">)</span></div>

        

<div class="viewcode-block" id="Output.get_formatted_string">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Output.get_formatted_string">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">get_formatted_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">format_sheet</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Pref</span><span class="p">(</span><span class="s1">&#39;get_formatted_string.format sheet&#39;</span><span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an output file to a (mostly) human-readable string format. </span>
<span class="sd">        This will only display the values in the header of the output file and </span>
<span class="sd">        it uses one of the format sheets located in the ``format_sheets`` </span>
<span class="sd">        directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : :class:`~.Output`</span>
<span class="sd">            The output file to convert to a string.</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        format_sheet : str, None, default = ``Pref(&#39;get_formatted_string.format sheet&#39;)``</span>
<span class="sd">            The format sheet to use when converting.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The formatted string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.formatter</span>
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="n">format_sheet</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">if</span> <span class="n">has_matplotlib</span><span class="p">:</span>
        <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
        <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">ax</span> <span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                <span class="n">y</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a scatter plot on the given Matplotlib axes showing the</span>
<span class="sd">            particle values.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ax : matplotlib.axes.Axes</span>
<span class="sd">                The axis to make the plot on.</span>

<span class="sd">            x : str, default = &#39;x&#39;</span>
<span class="sd">                The output file key to plot on the x-axis.</span>

<span class="sd">            y : str, default = &#39;y&#39;</span>
<span class="sd">                The output file key to plot on the y-axis.</span>

<span class="sd">            Other Parameters</span>
<span class="sd">            ----------------</span>
<span class="sd">            kwargs</span>
<span class="sd">                Keyword arguments are passed directly to </span>
<span class="sd">                :class:`starsmashertools.mpl.artists.OutputPlot` .</span>
<span class="sd">            </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            :class:`starsmashertools.mpl.artists.OutputPlot`</span>
<span class="sd">                A Matplotlib ``Artist``\.</span>

<span class="sd">            See Also</span>
<span class="sd">            --------</span>
<span class="sd">            :mod:`starsmashertools.preferences` (&#39;Plotting&#39;), </span>
<span class="sd">            :class:`starsmashertools.mpl.artists.OutputPlot`</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">import</span> <span class="nn">starsmashertools.mpl.artists</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">artists</span><span class="o">.</span><span class="n">OutputPlot</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span></div>

















































    


        









<span class="c1"># Asynchronous output file reading</span>
<div class="viewcode-block" id="OutputIterator">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.OutputIterator">[docs]</a>
<span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">use</span>
<span class="k">class</span> <span class="nc">OutputIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An iterator which can be used to iterate through :class:`~.Output` objects</span>
<span class="sd">    efficiently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="OutputIterator.__init__">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.OutputIterator.__init__">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filenames</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">simulation</span><span class="p">,</span>
            <span class="n">onFlush</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="n">max_buffer_size</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Pref</span><span class="p">(</span><span class="s1">&#39;max buffer size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">asynchronous</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filenames : list, tuple, :class:`numpy.ndarray`</span>
<span class="sd">            The list of file names to iterate through.</span>

<span class="sd">        simulation : :class:`~starsmashertools.lib.simulation.Simulation`</span>
<span class="sd">            The simulation that the given file names belong to.</span>

<span class="sd">        onFlush : list, tuple, :class:`numpy.ndarray`\, default = []</span>
<span class="sd">            A list of functions to be called in the :meth:`~.flush` method. If </span>
<span class="sd">            one of the methods returns ``&#39;break&#39;`` then iteration is stopped and</span>
<span class="sd">            no other ``onFlush`` functions are called.</span>

<span class="sd">        max_buffer_size : int, default = ``Pref(&#39;max buffer size&#39;, 100)``</span>
<span class="sd">            The maximum size of the buffer for reading Output ahead-of-time.</span>
<span class="sd">        </span>
<span class="sd">        asynchronous : bool, default = True</span>
<span class="sd">            If `True`\, Output objects are read asynchronously in a separate</span>
<span class="sd">            process than the main thread. Otherwise, Output objects are read on</span>
<span class="sd">            an &quot;as needed&quot; basis in serial.</span>
<span class="sd">        </span>
<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Other optional keyword arguments that are passed to the</span>
<span class="sd">            :meth:`~.Output.read` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.lib.simulation</span>
        
        <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span><span class="p">({</span>
            <span class="s1">&#39;simulation&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">starsmashertools</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">Simulation</span><span class="p">],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_buffer_size</span> <span class="o">=</span> <span class="n">max_buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onFlush</span> <span class="o">=</span> <span class="n">onFlush</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span> <span class="o">=</span> <span class="n">asynchronous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">onFlush</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Callbacks in keyword &#39;onFlush&#39; must be callable, but received &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

        <span class="c1"># Make sure that the filenames are the true paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">filenames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_break</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="s2">&quot;&quot;</span>
        <span class="n">bname1</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">bname1</span><span class="p">)</span>
        <span class="n">bname2</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; ... &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bname1</span><span class="p">,</span> <span class="n">bname2</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Output</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">item</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.asynchronous</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_index</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_buffer_size</span><span class="p">:</span>
            <span class="c1"># Wait for the process to be finished before continuing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asynchronous</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">asynchronous</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">,</span>
                    <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure that we do the flush methods whenever we stop iterating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">onFlush</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">==</span> <span class="s1">&#39;break&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_break</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">Output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span>

    <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span></div>








<div class="viewcode-block" id="ParticleIterator">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.ParticleIterator">[docs]</a>
<span class="k">class</span> <span class="nc">ParticleIterator</span><span class="p">(</span><span class="n">OutputIterator</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to an :class:`~.OutputIterator`, but instead of iterating through </span>
<span class="sd">    all the particles in each Output file, we iterate through a list of</span>
<span class="sd">    particles instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ParticleIterator.__init__">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.ParticleIterator.__init__">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">particle_IDs</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="c1"># 0th index</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">particle_IDs</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="n">particle_IDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">particle_IDs</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParticleIterator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span> <span class="o">=</span> <span class="n">particle_IDs</span></div>


    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.readonlydict</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># Calculate the file position for the quantity we want to read</span>
        <span class="n">header_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
        <span class="n">header_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_dtype</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span>
        
        <span class="n">data_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">_dtype</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span><span class="p">)</span>
        <span class="n">IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span><span class="p">)[</span><span class="n">sort_indices</span><span class="p">]</span>
        <span class="c1"># Each 4 is a Fortran record marker</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">header_stride</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">data_stride</span> <span class="o">+</span> <span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">ID</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">IDs</span><span class="p">]</span>

        <span class="c1"># Calling Reader.read also ensures that the proper Fortran write</span>
        <span class="c1"># statements have been located ahead of time</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">return_headers</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">0</span><span class="p">,</span><span class="n">access</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">ACCESS_READ</span><span class="p">)</span>
        
        <span class="n">_buffer</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_stride</span> <span class="o">+</span> <span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">IDs</span><span class="p">,</span> <span class="n">positions</span><span class="p">)):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_stride</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">_buffer</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">data_stride</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">position</span> <span class="p">:</span> <span class="n">position</span> <span class="o">+</span> <span class="n">data_stride</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span>
            <span class="n">buffer</span><span class="o">=</span><span class="n">_buffer</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">strides</span><span class="o">=</span><span class="n">data_stride</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sort_indices</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">readonlydict</span><span class="o">.</span><span class="n">ReadOnlyDict</span><span class="p">(</span>
            <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">}</span> <span class="o">|</span> \
            <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="s1">&#39;ID&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_IDs</span><span class="p">}</span>
        <span class="p">)</span></div>


                
                




































    



<div class="viewcode-block" id="Reader">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Reader">[docs]</a>
<span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">preferences</span><span class="o">.</span><span class="n">use</span>
<span class="k">class</span> <span class="nc">Reader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">simulation</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_endian</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;header&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;format&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;variables&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;data&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;format&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;variables&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_endian</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endian</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_endian</span> <span class="o">=</span> <span class="s1">&#39;little&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_endian</span> <span class="o">=</span> <span class="s1">&#39;big&#39;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endian</span>
    
    <span class="k">def</span> <span class="nf">read_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No key &#39;</span><span class="si">%s</span><span class="s2">&#39; in the dtypes&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
        
        <span class="k">with</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[:</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]]))</span>
            <span class="k">return</span> <span class="n">variable</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_endian</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filename</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">return_headers</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">return_data</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.path</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">return_headers</span><span class="p">,</span> <span class="n">return_data</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of &#39;return_headers&#39; or &#39;return_data&#39; must be True&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="n">endian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_endian</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Check how many rows of data the file has</span>
                <span class="c1"># The last thing written to the file must always be variable</span>
                <span class="c1"># &quot;ntot&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">recl</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="n">endian</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">recl</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="mi">4</span>
                <span class="n">ntot</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">recl</span><span class="p">),</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="n">endian</span><span class="p">)</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
                <span class="c1"># Compare the number of lines to the written number of particles</span>
                <span class="c1"># at the end of the file. This number must always be written as</span>
                <span class="c1"># a regular Fortran integer</span>
                <span class="k">if</span> <span class="n">nlines</span> <span class="o">!=</span> <span class="n">ntot</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Reader</span><span class="o">.</span><span class="n">CorruptedFileError</span><span class="p">(</span><span class="s2">&quot;nlines != ntot (</span><span class="si">%d</span><span class="s2"> != </span><span class="si">%d</span><span class="s2">). This Output might have been written by a different simulation. Make sure you use the correct simulation when creating an Output object, as different simulation directories have different reading and writing methods in their source directories: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nlines</span><span class="p">,</span> <span class="n">ntot</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">return_headers</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span>
                        <span class="n">buffer</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]),</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># start-of-record</span>
                        <span class="n">strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
                    <span class="c1"># Go past the header&#39;s trailing record marker, to the start</span>
                    <span class="c1"># of the first data row&#39;s record marker</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span>
                        <span class="c1"># mmap speeds up reading significantly, but is about 2x</span>
                        <span class="c1"># slower when reading only the header.</span>
                        <span class="n">buffer</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">ACCESS_READ</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="n">ntot</span><span class="p">,</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                        <span class="c1"># Start at the beginning of the first record, beyond the</span>
                        <span class="c1"># record marker for the first line of data.</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="c1"># Skip the record markers at the end of each row, and at</span>
                        <span class="c1"># the beginning of each next row.</span>
                        <span class="n">strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Reader</span><span class="o">.</span><span class="n">CorruptedFileError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Reader</span><span class="o">.</span><span class="n">CorruptedFileError</span><span class="p">(</span><span class="s2">&quot;This Output might have been written by a different simulation. Make sure you use the correct simulation when creating an Output object, as different simulation directories have different reading and writing methods in their source directories: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">raise</span>

        <span class="c1"># Convert to read-only dictionaries</span>
        <span class="k">if</span> <span class="n">return_headers</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">readonlydict</span><span class="o">.</span><span class="n">ReadOnlyDict</span><span class="p">(</span>
                <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">readonlydict</span><span class="o">.</span><span class="n">ReadOnlyDict</span><span class="p">(</span>
                <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">}</span> <span class="o">|</span> \
                <span class="p">{</span><span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ntot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)}</span> <span class="c1"># Always include an &#39;ID&#39; key</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">return_headers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_data</span><span class="p">:</span> <span class="k">return</span> <span class="n">header</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_headers</span> <span class="ow">and</span> <span class="n">return_data</span><span class="p">:</span> <span class="k">return</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">return_headers</span> <span class="ow">and</span> <span class="n">return_data</span><span class="p">:</span> <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span>
    
<div class="viewcode-block" id="Reader.get_starsmasher_write_statements">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Reader.get_starsmasher_write_statements">[docs]</a>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">get_starsmasher_write_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        statement : list</span>
<span class="sd">            The lines of Fortran code that contains the &quot;write&quot; Fortran </span>
<span class="sd">            directive from the `StarSmasher` source code.</span>
<span class="sd">        </span>
<span class="sd">        variables : list</span>
<span class="sd">            Each element is a list of :class:`~.helpers.fortran.Variable` </span>
<span class="sd">            objects corresponding with the variables that are involved with each</span>
<span class="sd">            write statement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fortran_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_source_files</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">statement</span><span class="p">,</span> <span class="n">varis</span> <span class="ow">in</span> <span class="n">fortran_file</span><span class="o">.</span><span class="n">get_write_statements</span><span class="p">():</span>
                <span class="n">statements</span> <span class="o">+=</span> <span class="p">[</span><span class="n">statement</span><span class="p">]</span>
                <span class="n">variables</span> <span class="o">+=</span> <span class="p">[</span><span class="n">varis</span><span class="p">]</span>
                <span class="n">files</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fortran_file</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">statements</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">files</span></div>

    
<div class="viewcode-block" id="Reader.set_write_statements">
<a class="viewcode-back" href="../../../lib/starsmashertools.lib.output.html#starsmashertools.lib.output.Reader.set_write_statements">[docs]</a>
    <span class="nd">@starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">argumentenforcer</span><span class="o">.</span><span class="n">enforcetypes</span>
    <span class="nd">@api</span>
    <span class="k">def</span> <span class="nf">set_write_statements</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">header</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">data</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually set the header and data write statements from the StarSmasher</span>
<span class="sd">        Fortran source code. This is helpful in case there are multiple write</span>
<span class="sd">        statements of the same formatting and you want to distinguish which of</span>
<span class="sd">        them actually gets used in the simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : str, None, default = None</span>
<span class="sd">            The Fortran write statement used to create the headers. If `None`\,</span>
<span class="sd">            this parameter is ignored.</span>

<span class="sd">        data : str, None, default = None</span>
<span class="sd">            The Fortran write statement used to create the data rows. If </span>
<span class="sd">            `None`\, this parameter is ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">write_statements</span><span class="p">,</span> <span class="n">ws_vars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starsmasher_write_statements</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">statement</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">fortran</span><span class="o">.</span><span class="n">is_stripped</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">statement</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">fortran</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">statement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">write_statements</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to find an identical write statement in the StarSmasher source code as:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">statement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws_vars</span><span class="p">[</span><span class="n">write_statements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">statement</span><span class="p">)]</span></div>

    
    
    <span class="k">def</span> <span class="nf">update_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search the StarSmasher source directory for all fortran &quot;write&quot; </span>
<span class="sd">        statements and check to see if each write statement fits the formatting</span>
<span class="sd">        of the out*.sph file. Raises an exception when more than one valid </span>
<span class="sd">        format is located.</span>

<span class="sd">        Note that strings are not permitted in the output files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.file</span>
        <span class="kn">import</span> <span class="nn">starsmashertools.helpers.fortran</span>
        
        <span class="c1"># Figure out the length of the header and body. No need to lock the file</span>
        <span class="c1"># because starsmashertools never edits StarSmasher outputs.</span>
        <span class="n">endian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_endian</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">endian</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">endian</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">fortran</span><span class="o">.</span><span class="n">get_endian_from_file</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">recl</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="n">endian</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">recl</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">recl</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">byteorder</span> <span class="o">=</span> <span class="n">endian</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">dataline</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">recl</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>

        <span class="c1"># Now we know the header contents and the contents of the first line of</span>
        <span class="c1"># data in the file. We try to locate the write statement that was</span>
        <span class="c1"># responsible for writing the header and each row of data. Note that it</span>
        <span class="c1"># is possible for there for be more than one valid write statement, but</span>
        <span class="c1"># we are not doing a full translation of the fortran code into python,</span>
        <span class="c1"># so we can&#39;t know which one is correct.</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
            <span class="n">write_statements</span><span class="p">,</span> <span class="n">ws_vars</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starsmasher_write_statements</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">byte_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">],[</span><span class="n">header</span><span class="p">,</span><span class="n">dataline</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variables</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ws_vars</span><span class="p">):</span>
                <span class="n">attempt</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">fortran</span><span class="o">.</span><span class="n">get_numpy_format</span><span class="p">(</span>
                    <span class="n">byte_data</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">endian</span> <span class="o">=</span> <span class="n">endian</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">indices</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Found no possible write statements in the StarSmasher source code that correspond with </span><span class="si">%s</span><span class="s2"> information in file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="s2">&quot;Found more than one possible write statements in the StarSmasher source code that correspond with </span><span class="si">%s</span><span class="s2"> information in file &#39;</span><span class="si">%s</span><span class="s2">&#39;. Please choose one of the following write statements and manually set it for this reader, using </span><span class="se">\&quot;</span><span class="s2">simulation.reader.set_write_statements(</span><span class="si">%s</span><span class="s2"> = ...)</span><span class="se">\&quot;</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">p1</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">write_statements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_write_statements</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">s</span><span class="p">:</span><span class="n">write_statements</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]})</span>
        
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">byte_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">],[</span><span class="n">header</span><span class="p">,</span><span class="n">dataline</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starsmashertools</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">fortran</span><span class="o">.</span><span class="n">get_numpy_format</span><span class="p">(</span>
                <span class="n">byte_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">],</span>
                <span class="n">endian</span> <span class="o">=</span> <span class="n">endian</span><span class="p">,</span>
            <span class="p">)</span>
        
        
        <span class="n">header_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
        <span class="n">data_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
        <span class="n">header_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]]</span>
        <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="n">header_names</span><span class="p">,</span><span class="n">data_names</span><span class="p">],</span>
                <span class="p">[</span><span class="n">header_fmt</span><span class="p">,</span><span class="n">data_fmt</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stride</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span><span class="nb">sum</span><span class="p">([</span>
                <span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formats</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
            <span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">class</span> <span class="nc">CorruptedFileError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">CorruptedFileError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">SourceDirectoryNotFoundError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Failed to find the code source directory in simulation &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">simulation</span><span class="o">.</span><span class="n">directory</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">SourceDirectoryNotFoundError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Roger Hatfull.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>